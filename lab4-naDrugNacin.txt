1.

WITH FilteredTransakcija AS (
    SELECT ID_v
    FROM Transakcija_shalter
    JOIN Smetka ON Transakcija_shalter.broj = Smetka.broj
    WHERE valuta = 'EUR' AND tip = 'isplata' AND suma > 1000
),
MatchingVraboten AS (
    SELECT DISTINCT Vraboten.ID, ime, prezime
    FROM Vraboten
    JOIN Shalterski_rabotnik ON Vraboten.ID = Shalterski_rabotnik.ID
    WHERE Vraboten.ID IN (SELECT ID_v FROM FilteredTransakcija)
)
SELECT ime, prezime
FROM MatchingVraboten
ORDER BY ime, prezime;

2.

SELECT DISTINCT k.ime, k.prezime
FROM Klient k
INNER JOIN Smetka s ON k.MBR_k = s.MBR_k
INNER JOIN Transakcija_bankomat t ON s.broj = t.broj
WHERE s.valuta = 'USD' AND t.suma > 400
ORDER BY k.ime;


3.

select Smetka.MBR_k,Smetka.broj,valuta,saldo 
from smetka 
join 
Transakcija_shalter on smetka.broj=Transakcija_shalter.broj
where valuta='MKD' and datum like '2021-__-__' and tip='isplata'

intersect

select Smetka.MBR_k,Smetka.broj,valuta,saldo 
from smetka 
join 
Transakcija_bankomat on smetka.broj=Transakcija_bankomat.broj
where valuta='MKD' and datum like '2021-__-__'



4.

SELECT Klient.MBR_k, Klient.ime, Klient.prezime, Klient.adresa, Klient.datum 
FROM Klient
JOIN Smetka ON Klient.MBR_k = Smetka.MBR_k
JOIN Transakcija_bankomat ON Smetka.broj = Transakcija_bankomat.broj
WHERE Smetka.valuta = 'EUR' AND Smetka.broj NOT IN (
    SELECT Smetka.broj
    FROM Smetka
    JOIN Transakcija_shalter ON Smetka.broj = Transakcija_shalter.broj
)
ORDER BY Klient.ime;



5.

select Vraboten.ID, Transakcija_shalter.datum, count(*) 
as broj_transakcii 
from Vraboten join  Shalterski_rabotnik
on Vraboten.ID = Shalterski_rabotnik.ID join 
Transakcija_shalter on Shalterski_rabotnik.ID =
Transakcija_shalter.ID_v
group by Shalterski_rabotnik.ID, Transakcija_shalter.datum
order by broj_transakcii desc


6.

SELECT 
    s.MBR_k, 
    s.broj, 
    AVG(tb.suma) AS prosechna_isplata_bankomat, 
    AVG(ts.suma) AS prosechna_isplata_shalter
FROM 
    Smetka s
JOIN 
    Transakcija_bankomat tb ON s.broj = tb.broj AND tb.datum LIKE '2021%'
JOIN 
    Transakcija_shalter ts ON s.broj = ts.broj AND ts.tip = 'isplata' AND ts.datum LIKE '2021%'
WHERE 
    s.valuta = 'EUR' OR s.valuta = 'USD'
GROUP BY 
    s.broj
ORDER BY 
    s.broj;




